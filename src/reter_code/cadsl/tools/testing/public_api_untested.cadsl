# public_api_untested - Find public API without tests
#
# Identifies public API entities that have no test coverage.

detector public_api_untested(category="test_coverage", severity="high") {
    """Find public API without test coverage."""

    param limit: int = 100;

    reql {
        SELECT ?e ?name ?entity_type ?file ?line
        WHERE {
            { ?e type class } UNION { ?e type function }
            ?e has-name ?name .
            ?e is-in-file ?file .
            ?e is-at-line ?line .
            ?e isExported true .
            FILTER ( !REGEX(?name, "^_") && !REGEX(?file, "test_|_tests?\\.|/tests?/") )
            MINUS { ?test calls ?e . ?test is-in-file ?test_file . FILTER ( REGEX(?test_file, "test_|_tests?\\.|/tests?/") ) }
        }
        ORDER BY ?entity_type ?name
        LIMIT {limit}
    }
    | select { name, entity_type, file, line }
    | map {
        ...row,
        issue: "public_api_untested",
        message: "Public API {entity_type} '{name}' has no tests",
        suggestion: "Critical: public API must have test coverage"
    }
    | emit { findings }
}

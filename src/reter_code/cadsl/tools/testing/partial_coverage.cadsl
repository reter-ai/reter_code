# partial_coverage - Find classes with partial test coverage
#
# Identifies classes where some but not all public methods are tested.

detector partial_class_coverage(category="test_coverage", severity="low") {
    """Find classes with partial test coverage."""

    param limit: int = 100;

    reql {
        SELECT ?c ?name ?file ?line (COUNT(?method) AS ?total_methods) (COUNT(?tested) AS ?tested_methods)
        WHERE {
            ?c type class .
            ?c has-name ?name .
            ?c is-in-file ?file .
            ?c is-at-line ?line .
            ?method type method .
            ?method is-defined-in ?c .
            ?method has-name ?method_name .
            FILTER ( !STRSTARTS(?method_name, "_") )
            OPTIONAL {
                ?test calls ?method .
                ?test is-in-file ?test_file .
                FILTER ( REGEX(?test_file, "test_|_tests?\\.|/tests?/") )
            }
        }
        GROUP BY ?c ?name ?file ?line
        HAVING (?tested_methods > 0 && ?tested_methods < ?total_methods && ?total_methods > 2)
        ORDER BY ?tested_methods
        LIMIT {limit}
    }
    | select { name, file, line, tested_methods, total_methods }
    | compute {
        coverage_ratio: tested_methods / (total_methods ?? 1)
    }
    | map {
        ...row,
        issue: "partial_coverage",
        message: "Class '{name}' has {tested_methods}/{total_methods} methods tested",
        suggestion: "Add tests for remaining public methods"
    }
    | emit { findings }
}

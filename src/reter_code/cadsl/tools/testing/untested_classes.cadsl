# untested_classes - Find classes without corresponding test classes
#
# Identifies classes that have no test coverage.

detector untested_classes(category="test_coverage", severity="medium") {
    """Find classes without corresponding test classes."""

    param limit: int = 100;

    reql {
        SELECT ?c ?name ?file ?line (COUNT(?method) AS ?method_count)
        WHERE {
            ?c type class .
            ?c has-name ?name .
            ?c is-in-file ?file .
            ?c is-at-line ?line .
            OPTIONAL { ?method type method . ?method is-defined-in ?c }
            FILTER ( !REGEX(?name, "^Test|Test$|^_") && !REGEX(?file, "test_|_tests?\\.|/tests?/") )
            MINUS {
                ?test type class .
                ?test has-name ?test_name .
                FILTER ( REGEX(?test_name, "^Test|Test$") )
            }
        }
        GROUP BY ?c ?name ?file ?line
        ORDER BY ?file ?name
        LIMIT {limit}
    }
    | select { name, file, line, method_count }
    | map {
        ...row,
        issue: "untested_class",
        message: "Class '{name}' has no test class",
        suggestion: "Create a test class 'Test{name}' or '{name}Test'"
    }
    | emit { findings }
}

# complex_untested - Find complex code without tests
#
# Identifies long methods/functions that have no test coverage.

detector complex_untested(category="test_coverage", severity="high") {
    """Find complex code without test coverage."""

    param min_lines: int = 30;
    param limit: int = 100;

    reql {
        SELECT ?e ?name ?class_name ?file ?line ?line_count
        WHERE {
            { ?e type oo:Method } UNION { ?e type oo:Function }
            ?e name ?name .
            ?e inFile ?file .
            ?e atLine ?line .
            ?e lineCount ?line_count .
            OPTIONAL { ?e definedIn ?c . ?c name ?class_name }
            FILTER ( ?line_count >= {min_lines} )
            FILTER ( !REGEX(?file, "test") )
            FILTER NOT EXISTS {
                ?test calls ?e .
                ?test inFile ?test_file .
                FILTER ( REGEX(?test_file, "test") )
            }
        }
        ORDER BY DESC(?line_count)
        LIMIT {limit}
    }
    | select { name, class_name, file, line, line_count }
    | compute {
        entity_type: class_name ? "method" : "function"
    }
    | map {
        ...row,
        issue: "complex_untested",
        message: "Long {entity_type} '{name}' ({line_count} lines) has no tests",
        suggestion: "High-risk: add comprehensive tests for complex logic"
    }
    | emit { findings }
}
